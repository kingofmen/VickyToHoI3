\documentclass[12pt,ebook,oneside]{book}

\usepackage{graphicx} 
\usepackage{layouts} 
\usepackage{hyperref} 
\textheight=1.2\textheight

\begin{document}

\section{How to use the converter}

\begin{itemize}
\item Download the zip file: \url{https://github.com/kingofmen/VickyToHoI3/archive/master.zip}.
\item Unpack it. 
\item Ignore the source code unless you intend to modify it. 
\item Copy the Vicky savegame you intend to convert into the release
  directory. 
\item Start the VickyToHoI3 executable. 
\item Go to File->Load file and select your savegame. 
\item Wait for it to load - it will take a minute or two. If it takes
  more than five minutes, you have either a very slow computer, or a
  problem - go to Troubleshooting, below. 
\item Go to Actions->Convert to HoI. Wait until it says ``Done
  writing''. If the output stops for more than a few minutes with any
  other message, especially one starting `Error', go to
  Troubleshooting. 
\item Conversion is now done. Go to the Output directory. It should
  contain `converted.hoi3'. Move this to your HoI savegames folder; on
  my machine this is on C:\\Users\\UserName\\My Documents\\Paradox
  Interactive\\Hearts of Iron III, but installations differ. 
\item Start HoI3 as usual. The converted game should appear as a
  regular saved game; select your country and play. If it crashes or
  hangs on loading, or within a few days of starting, go to
  Troubleshooting. 
\item Conquer \emph{All} the Pixels! 
\end{itemize}

\section{Troubleshooting}

These are the most common issues people have had:
\begin{itemize}
\item HoI crashes on loading the converted save. This is very often a
  bug, which I'll try to fix (see below). However, there are two
  causes that you can fix yourself: One, your Victoria savegame
  has army or navy names containing a hashtag, `\#'. This confuses the
  parser. In that case just remove the hashtag. (Removing other
  unusual characters may also be worth a try.) Two, do note that the
  converted savegame is meant for HoI3 with all three expansions, and
  that if you don't have all three the game will choke.
\item No converted save file. This is often caused by
  impatience. Don't click ``convert'' immediately after ``load file'',
  it takes some time to parse forty megabytes of savegame.
\item Borders look weird. Yes, sorry. The province conversion file is
  not that good. You can fix the most egregious offenders by editing
  HoI\_TFH/province\_mappings.txt. If you do, please send me your
  edits (ideally as a GitHub pull request, but if you don't know how
  to do that, send me the edited file) so others can benefit.
\item Ahistorical governments. This is by design. The converter is
  intended for MP games that started in Crusader Kings; the world
  history is going to look extremely different. Historical governments
  would make very little sense in this case. If your game started in
  Vicky (for some reason, multiplayer games that last two years seem
  to be a minority taste) you can try changing 'historicalGovs' in the
  config file to 'yes'.
\item Weird tag conversions, eg Bavaria ends up as Manchukuo. This
  happens because HoI doesn't have enough tags; ahistorical survivals
  have to make do with the few unused tags that exist in the 1936
  scenario. Personally I just ignore this kind of thing, but if having
  the wrong flag bothers you, there are two options:
\begin{itemize}
\item Edit HoI so the tag 'MCH' (Manchukuo) has the flag and text
  belonging to 'BAV' (Bavaria).
\item Change V2\_HoD/country\_mappings.txt so
\begin{verbatim}
link = { vic = GER hoi = GER }
\end{verbatim}
becomes instead
\begin{verbatim}
link = { vic = BAV hoi = GER }
\end{verbatim}
This means that Victoria Germany will likely become Manchukuo instead,
but if Bavaria has survived and you care about it, Germany is perhaps
not so important.
\end{itemize}
\end{itemize}

If none of the above is your problem: Upload your (zipped) Victoria
savegame somewhere, then send me (``King of Men'') a PM on Paradox,
Ederon, or (``King\_of\_Men'') reddit with a link to the upload. Try to be as
specific as possible about what the problem is - I cannot debug
``things look weird''. Screenshots and province IDs are often
helpful. I'll run the
debugging version of the converter and try to fix the
problem. If you are skilled at C++ development in Windows you can also
try to compile in debug mode and run gdb on it. 


\section{Resources}

Resources convert from Vicky RGOs. In particular, the
\texttt{crude\_oil}, \texttt{metal}, \texttt{rare\_materials}, and
\texttt{energy} fields of \texttt{config.txt} regulate how much weight
each Vicky resource has for the eponymous HoI resource; each RGO then
has this weight (if not listed, it is zero) times its
\texttt{last\_income} field. 

\section{Manpower and leadership}

All POPs listed in the \texttt{fightingClasses} object have a
redistribution weight for manpower equal to their size, \emph{unless}
they work in an RGO type listed in the \texttt{manpower} object, in
which case their weight is calculated as for a resource. Notice that
by default the \texttt{manpower} object contains RGOs that have
nonzero weights for resource, and the weights in it are all zero. The
effect is that labourers who work in resource-giving RGOs do not give
manpower. 

Leadership is redistributed according to the ratios of the POP types
listed in the \texttt{officerClasses} object. The first number is the
optimal ratio (from Vicky); the second is the weight for the
class. The leadership weight of a nation equals its ratio of the
listed classes, times their weights, capped at the optimal ratio. This
is then multiplied by a factor that depends on how powerful the
country is; for Great Powers it is 1, for secondary powers 0.9, and
for everyone else 0.1. Note that the definition of Great and Secondary
power varies somewhat from Victoria's, because the military and
industrial scores are not stored directly in the savefile. In
particular, the countries are sorted by their HoI industry, and the
first eight are considered Great Powers; there is a huge bonus to
industry if the \texttt{last\_greatness\_date} of the nation is within
100 days of the save date, which should put all countries that
Victoria thinks are Great Powers into these first eight. To
become a secondary power the country must have rank 9 through 16, and
must also have at least one-tenth the industry of the next greater
power; this is to prevent three-province minors from being secondary
powers (and getting lots of leadership) just because there aren't very
many powerful nation. So, for example, if Sweden is ranked 12th and
has 100 industry, and Afghanistan is 11th at 9 industry, then Sweden
is a secondary power, but Afghanistan and all subsequent countries are
minors. 
Finally this leadership is distributed
within the nation according to where the listed POP types are. 

\section{Industry} 

Vicky factories convert to HoI industrial capacity with a weight
proportional to their revenue, which is given by production times the
price of the good produced. The world total of IC remains what it
is in the input file. Unemployed and subsidised workers count as
making \texttt{minimumProfitRate} for weighting purposes, but the IC
they create starts damaged. Employed workers who make a positive
revenue less than \texttt{minimumProfitRate} count as making it; this
means that it is never useful to close a profitable factory, though
there is some advantage to having factories that are only just barely
profitable. Production that would exist if not for war exhaustion is
created as damaged IC; the conversion here is not entirely exact,
accounting only for throughput bonuses from technology, but not from
inventions or governments. Naval bases count as factories employing
\texttt{navalBaseWorkers} per force-limit contribution, and making
\texttt{minimumProfitRate} for each of them. War and heavy industries
get a small bonus to their weight. 

\section{Governments}

Each converted nation gets the government of the historical nation it
most closely resembles, provided no other nation resembles it even
more. That is, a resemblance is calculated for each pair of converted
and historical nations. The highest resemblance is then assigned, then
the next highest for which neither converted or historical nation has
already been used, and so on until all converted nations have a
government. For example, suppose the converted nations are SWE, DEN,
and NOR; and the historical nations are GER, ENG, and FRA. Suppose
further that the resemblances are thus:
\begin{verbatim}
SWE - GER: 10
SWE - ENG: 8
SWE - FRA: 3
DEN - GER: 9
DEN - ENG: 7
DEN - FRA: 2
NOR - GER: 2
NOR - ENG: 4
NOR - FRA: 3
\end{verbatim}
Sorting this list from highest to lowest, we get:
\begin{verbatim}
SWE - GER: 10
DEN - GER: 9
SWE - ENG: 8
DEN - ENG: 7
NOR - ENG: 4
NOR - FRA: 3
SWE - FRA: 3
DEN - FRA: 2
NOR - GER: 2
\end{verbatim}
Thus, SWE gets the historical GER government, and SWE and GER are
struck from the list, leaving:
\begin{verbatim}
DEN - ENG: 7
NOR - ENG: 4
NOR - FRA: 3
DEN - FRA: 2
\end{verbatim}
Then, DEN gets the historical ENG government and these tags are
struck, leaving only the final resemblance, from which NOR is assigned
the FRA government. 

Resemblance is calculated from the \texttt{govResemblance} object in
the configuration file. For example, consider the resemblance object
to Sweden:
\begin{verbatim}
  SWE = {
    scale = 0.5
    government = {
      fascist_dictatorship = 0
      proletarian_dictatorship = 0 
      presidential_dictatorship = 0
      bourgeois_dictatorship = 0
      absolute_monarchy = 0.1
      prussian_constitutionalism = 0.8
      hms_government = 0.5
      democracy = 0.8
    }
  }
\end{verbatim}
This says that a Victoria nation gets 0.8 resemblance points to Sweden for
having the \texttt{prussian\_constitutionalism} government, 0.5 for
\texttt{hmc\_government}, and so on. Resemblances are multiplied by
the \texttt{scale}, which is 1 by default and smaller for
historically-minor countries like Sweden; this means that a country
which equally resembles Germany and Sweden will get the German
government if it is available. In addition, human countries get a
bonus of \texttt{humanFactor} to all resemblances listed in the config
file, to advantage them
over AI minors in the scramble for interesting governments. There is
also a tiny random factor to break ties. 

Fields marked `numerical', such as plurality, create a resemblance of
their \texttt{value} key times the number in the Victoria
country. Fields with a `target' keyword look in the nested sub-object of
the Victoria nation rather than the top level. 

\section{Leaders}

Active leaders are redistributed randomly, weighted by the size of
army, navy (including bases), and air force. To ensure that releasable
nations have a minimum amount of officers, the sizes are calculated as
the real size plus \texttt{minimum\[Army,Navy,Wing\]Weight} from the
config file. 

\section{Buildings}

HoI naval bases are redistributed weighted by the Vic ones. Forts
convert directly except that the level is reduced by two, with coastal provinces gaining both sea and land
forts; the coast detection algorithm is heuristic
(specifically, it looks first for a naval base in the input, then in
the positions file to see if coordinates are given for a naval base)
and may miss some coastal provinces. 

Infrastructure converts ``urbanisation'', defined
as the ratio of clerks to labourers or farmers, plus the railroad
value times \texttt{infraWeight} from the config file. The Victoria provinces
are sorted by urbanisation and assigned the input
infrastructure in order, so that the highest urbanisation
Victoria province gets the highest infrastructure in the
input. Capitals have their urbanity doubled. No province can convert
with less than 2 infra unless it has no railroads in Vicky and level-1
infrastructure in the input save. 

AA batteries convert like infrastructure, in the most urbanised
provinces, on the assumption that large cities get such protection. 

Air bases - vexed issue that they are - convert similarly to
infrastructure, but the weighting is the number of workers in airplane
factories, plus 100 times the naval-base level, plus 100 times the
urbanisation. In addition, every capital gets at least a level-1
airbase if it doesn't get one by other means. 

\section{Orders of Battle}

Land units are created in numbers equalling the vanilla setup, so that
each nation gets a number of HoI units proportional to the amount of the
corresponding Victoria units it has. For example, all four
kinds\footnote{And really, does any game need four kinds of cavalry?}
of Vicky cavalry (cavalry, dragoon, hussar, and cuirassier) correspond
to HoI cavalry. Consequently, if a nation has 25 Victoria cavalry
regiments (all kinds) and the total of such units in Victoria is 100,
then it gets HoI cavalry equal to one-fourth of the amount that exists
in the input save. The unit correspondences are listed in the
\texttt{unitTypes} object of the config file. Notice that reserve
units (from mobilisation) do not count as infantry; notice also that
not every HoI unit type has a corresponding Victoria one. 

In some cases additional units will be created. For example, the 1936
setup has only two armoured brigades (as opposed to light armour),
which is experentially a somewhat absurd constraint to impose on a
Victoria game in 1936. Consequently additional armoured brigades are
created in accordance with the \texttt{extraUnits} field:
\begin{verbatim}
extraUnits = {
  armor_brigade = { tank 5 10 15 20 25 35 50 75 100 125 150 175 200 225 250 300 350 400 450 500 600 }
}
\end{verbatim}
which says that if the world contains 5 tank units, an additional
armoured brigade is created, another at 10, and so on up to 600; after
600 there is one for every 100, the difference between the last and
the second-last entries. 

A sufficient amount of divisions, corps and higher formations, with headquarters, are created to
house the lower formations; so three (identical) brigades form a
division, three divisions (identical or not) form a corps, and so
on. Any formations at loose ends are attached to the single theatre
that is created for each nation. 

Brigades have a chance of being created as reserve; the chance is
equal to the percentage of their brigade type that is reserve in the
input. Reserve brigades are created at full strength in nations that
are mobilised in Victoria, otherwise at the strength indicated by
the HoI conscription law. Note that HoI immediately mobilises nations
at war; a Victoria nation that is at war, but not mobilised, will
therefore begin the game with reserve units at low strength but
rapidly reinforcing up to 100\%. 

Ships are redistributed at random, weighted by the naval strength of
nations. Naval strength is defined as the sum of the weights given in
the \texttt{vicShips} field (that is, a dreadnought is 60, a cruiser
20, and so on), averaged with the naval support limit (which comes
from naval bases), \emph{unless} the former is higher than the latter,
in which case the naval force limit is used. Thus, suppose my naval
force limit is 100. If I build a single dreadnought (weight 60) my
naval strength is 80 (average of 60 and 100). If I build another
dreadnought (bringing the total weight to 120) my naval strength is
100 (the force limit). 

\section{Techs}

Most human players will be fully teched by 1936, so there is little to
distinguish nations on this point. The tech conversion is therefore
intended mainly to activate the obvious stuff, so players don't sit
about unable to build infantry divisions in 1936. The config file's
\texttt{techConversion} object contains fields of this form:
\begin{verbatim}
vicTech = { hoiTech hoiTech ... }
\end{verbatim}
where each \texttt{hoiTech} is increased to level one if the nation
has the \texttt{vicTech}. Otherwise all HoI techs start at zero. 

Practicals are gained from units, as regulated by the
\texttt{practicals} object. For example, the field
\begin{verbatim}
  infantry_practical = { infantry }
\end{verbatim}
indicates that Vicky infantry, as one might expect, gives the HoI
\texttt{infantry\_practical}. In particular, the nation with the most
Vicky infantry gains the highest practical that exists in the input
save; everyone else gets an amount proportional to their
infantry. Thus if the highest practical in historical 1936 is 10, and
Russia has 1000 infantry regiments in Victoria, a nation with 500
infantry regiments will get 5 infantry practical. For this purpose
forts and naval bases are weighted by level, and factories by the
number of employees. 

\section{Laws}

Law conversions are given by the \texttt{laws} object.
Laws convert in one of three ways:
\begin{itemize}
\item Points-based. The fields listed in \texttt{vicKeys} are
  examined, and the value gives the number of points listed in the
  \texttt{points} object. The total amount of points is then compared
  with the \texttt{hoiValues} object, and the law with the highest
  value less than the number of points is selected. 
\item Ratios. The \texttt{numerator} field is divided by
  \texttt{denominator} (note that many of these values do not exist in
  a Vicky save, but are calculated by the converter) and the selection
  then proceeds as for points - the law with the highest value less
  than the ratio is selected. 
\item By Victoria field: The \texttt{keyword} is examined and each
  possible value directly translates to a HoI law. 
\end{itemize}

\section{Diplomacy}

Wars, alliances, and vassalisations convert one for one; wargoals are
ignored. Factions are removed - no nation is a member of Axis, Allies, or
Comintern. 

Neutrality is linear in revanchism; it is 100 at 0 revanchism and
\texttt{minimumNeutrality} at full revanchism. It is adjusted by the
weighted number of casualties the nation has taken; the weight of a
casualty is $2^{-n}$ where $n$ is the number of years since the
battle. The rate of neutrality change per weighted casualty is given by
the \texttt{neutralityPerCasualty} field in the config file. For
nations actively at this is subtracted from neutrality; for those at
peace, it is added. 

Diplomatic influence converts one-for-one from diplomacy points. 

Relations convert directly. Threat is calculated from the relative
army sizes by a stepwise function which is best summarised by code:
\begin{verbatim}
if      (armyRatio < 0.5) threat = 0;
else if (armyRatio < 1.0) threat = (armyRatio - 0.5)*0.33;
else if (armyRatio < 1.5) threat = (0.5*0.33 + armyRatio-1);
else                      threat = (0.5*0.83 + (1-0.5*0.83)*(2/M_PI)*atan(armyRatio-1.5));
\end{verbatim}
where \texttt{armyRatio} is the amount of infantry of the threatening
nation divided by that of the threatened one. This gives a number
between zero and one, which is then multiplied into
\texttt{maxWarThreat} or \texttt{maxPaxThreat} from the config
file, depending on whether the nations are at war or not. If they are
at peace, this is further modified by a factor
\begin{eqnarray*}
P = \frac{2}{\pi}\arctan\left(\frac{1+B_t}{1+B_o}-1\right)
\end{eqnarray*}
where $B_t$ is the badboy of the threatening nation and $B_o$ that of
the threatened nation. To summarise, this means that a nation only
feels threat from a country it is at peace with if that country has a
larger badboy than itself.

\section{Miscellanea}

Manpower, officers, and resource stockpiles are distributed 
from the input, proportionally to the quantities listed in the
\texttt{stockpiles} object. The first entry indicates where in the HoI
country object the field is placed; the second, in what sub-object to
look for the Vicky quantity; the third, a minimum amount to serve as
an initial buffer; and the fourth and subsequent, the Vicky keywords. In both
cases \texttt{country} refers to the top-level nation
object. Note that for HoI, \texttt{cap\_pool} is not present in the
input save; it is constructed by the converter, and moved to the
nation's capital province after resources have been distributed. 

Unity is linear in average militancy; it is 100 at 0 militancy and
\texttt{minimumUnity} at 10 militancy. 

Dissent is equal to the percentage of Vicky population that belongs to a
rebel faction, multiplied by \texttt{rebelWeight}, plus average
militancy. 

Terrain can only be modified by changing terrain.bmp, and the
converter therefore leaves it alone even though this means historical
placement of urban provinces. However, it does print out a list of the
100 provinces with the highest population of clerks, craftsmen, and
bureaucrats, for use in modding. Note that this list is only printed
if the debug stream labeled 50 in the config file is set to 'yes'. 

Victory points convert similarly to infrastructure: Victoria provinces
are weighted, and the highest weight receives the highest VP value in
the input save, and so down the list until there are no more input
VPs. In this case the weights are given by the \texttt{victoryPoints}
object in the config file; factory types are interpreted as the number
of workers in that kind of factory in the province. The
\texttt{navalBase} and \texttt{isCapital} fields are special; the
former is a multiplier for the force-limit contribution of any naval
base in the province, the second a multiplier applied to capitals. In addition,
all HoI provinces listed in \texttt{strategic\_provinces}, and all
capitals, get at least one victory point. 

\section{Too many tags}

If there are more Victoria countries than there are HoI countries in
the input save, some Victoria countries will be absorbed. An absorbed
country contributes its provinces, but not its army or government, to
another. The priority for country conversions is:
\begin{itemize}
\item Overrides from \texttt{custom\_overrides.txt}.
\item Tag conversions from \texttt{country\_mappings.txt}.
\item Any remaining Victoria countries with provinces, in order of
  size.
\item Any Victoria revolters.
\end{itemize}
Only the third set can be absorbed. If a Victoria country with
provinces has no free HoI country to be converted to, it will be
absorbed into its overlord (if it is a vassal) or the country whose
capital is closest to its capital. 

If you have a Victoria mod with a lot of tags, you may want to try
converting to a HoI mod with extra tags. To do so, load up your HoI
mod, save on day 1, move that save to the HoI\_TFH directory,
and rename it to \texttt{input.hoi3}. Then load up the converted save
in the same mod. 

\end{document}
